<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Coach</title>
    <link rel="stylesheet" href="css/audio-coach.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”Š Audio Coach</h1>
            <p class="subtitle">Voice-guided coaching for Zwift</p>
        </header>

        <div class="status-bar">
            <div class="status-indicator">
                <span class="label">Status:</span>
                <span id="status" class="status-text inactive">Inactive</span>
            </div>
            <button id="toggleCoach" class="btn btn-primary">Start Coaching</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="settings">Settings</button>
            <button class="tab-btn" data-tab="intervals">Intervals</button>
            <button class="tab-btn" data-tab="live">Live Stats</button>
            <button class="tab-btn" data-tab="test">Test Audio</button>
        </div>

        <!-- Settings Tab -->
        <div class="tab-content active" id="settings-tab">
            <section class="card">
                <h2>General Settings</h2>
                <div class="form-group">
                    <label for="enabled">
                        <input type="checkbox" id="enabled" checked>
                        Enable Audio Alerts
                    </label>
                </div>
                <div class="form-group">
                    <label for="volume">Volume</label>
                    <input type="range" id="volume" min="0" max="1" step="0.1" value="0.8">
                    <span id="volume-value">80%</span>
                </div>
                <div class="form-group">
                    <label for="ftp">FTP (Watts)</label>
                    <input type="number" id="ftp" min="50" max="500" value="200" step="5">
                </div>
            </section>

            <section class="card">
                <h2>Power Zone Alerts</h2>
                <div class="form-group">
                    <label for="powerZoneAlerts">
                        <input type="checkbox" id="powerZoneAlerts" checked>
                        Enable Power Zone Alerts
                    </label>
                </div>
                <div class="form-group">
                    <label for="announceZoneChanges">
                        <input type="checkbox" id="announceZoneChanges" checked>
                        Announce Zone Changes
                    </label>
                </div>
                <div class="form-group">
                    <label for="targetZone">Target Zone (optional)</label>
                    <select id="targetZone">
                        <option value="">No Target</option>
                        <option value="1">Zone 1 - Recovery (&lt;55% FTP)</option>
                        <option value="2">Zone 2 - Endurance (55-75% FTP)</option>
                        <option value="3">Zone 3 - Tempo (75-90% FTP)</option>
                        <option value="4">Zone 4 - Threshold (90-105% FTP)</option>
                        <option value="5">Zone 5 - VO2 Max (105-120% FTP)</option>
                        <option value="6">Zone 6 - Anaerobic (&gt;120% FTP)</option>
                    </select>
                </div>
            </section>

            <section class="card">
                <h2>Climb Alerts</h2>
                <div class="form-group">
                    <label for="climbAlerts">
                        <input type="checkbox" id="climbAlerts" checked>
                        Enable Climb Detection
                    </label>
                </div>
                <div class="form-group">
                    <label for="climbGradientThreshold">Gradient Threshold (%)</label>
                    <input type="number" id="climbGradientThreshold" min="1" max="10" step="0.5" value="3.0">
                </div>
            </section>

            <section class="card">
                <h2>Pacing Alerts</h2>
                <div class="form-group">
                    <label for="pacingAlerts">
                        <input type="checkbox" id="pacingAlerts">
                        Enable Pacing Alerts
                    </label>
                </div>
                <div class="form-group">
                    <label for="pacingThreshold">Deviation Threshold (%)</label>
                    <input type="number" id="pacingThreshold" min="5" max="30" step="5" value="10">
                    <small>Alert when power deviates from target by this percentage</small>
                </div>
            </section>

            <div class="button-group">
                <button id="saveSettings" class="btn btn-success">Save Settings</button>
                <button id="resetSettings" class="btn btn-secondary">Reset to Defaults</button>
            </div>
        </div>

        <!-- Intervals Tab -->
        <div class="tab-content" id="intervals-tab">
            <section class="card">
                <h2>Interval Workout</h2>
                <div class="form-group">
                    <label for="countdownAlerts">
                        <input type="checkbox" id="countdownAlerts" checked>
                        Enable Countdown Alerts
                    </label>
                </div>
            </section>

            <section class="card">
                <h2>Quick Workout Templates</h2>
                <div class="button-group">
                    <button class="btn btn-secondary" data-workout="warmup">5min Warmup</button>
                    <button class="btn btn-secondary" data-workout="ftp-test">20min FTP Test</button>
                    <button class="btn btn-secondary" data-workout="vo2max">5x3min VO2 Max</button>
                    <button class="btn btn-secondary" data-workout="threshold">3x10min Threshold</button>
                </div>
            </section>

            <section class="card">
                <h2>Custom Intervals</h2>
                <div id="interval-list"></div>
                <button id="addInterval" class="btn btn-secondary">+ Add Interval</button>
            </section>

            <section class="card">
                <h2>Interval Control</h2>
                <div class="button-group">
                    <button id="startInterval" class="btn btn-primary">Start Workout</button>
                    <button id="stopInterval" class="btn btn-danger">Stop Workout</button>
                </div>
                <div id="interval-status" class="interval-status"></div>
            </section>
        </div>

        <!-- Live Stats Tab -->
        <div class="tab-content" id="live-tab">
            <section class="card">
                <h2>Current Stats</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Power</div>
                        <div class="stat-value" id="live-power">--</div>
                        <div class="stat-unit">watts</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Current Zone</div>
                        <div class="stat-value" id="live-zone">--</div>
                        <div class="stat-unit">power zone</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Heart Rate</div>
                        <div class="stat-value" id="live-hr">--</div>
                        <div class="stat-unit">bpm</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Cadence</div>
                        <div class="stat-value" id="live-cadence">--</div>
                        <div class="stat-unit">rpm</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Altitude</div>
                        <div class="stat-value" id="live-altitude">--</div>
                        <div class="stat-unit">meters</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Speed</div>
                        <div class="stat-value" id="live-speed">--</div>
                        <div class="stat-unit">km/h</div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2>Activity Log</h2>
                <div id="activity-log" class="activity-log"></div>
            </section>
        </div>

        <!-- Test Audio Tab -->
        <div class="tab-content" id="test-tab">
            <section class="card">
                <h2>Test Audio Output</h2>
                <div class="button-group">
                    <button id="testSpeech" class="btn btn-primary">Test Speech</button>
                    <button id="testBeep" class="btn btn-secondary">Test Beep</button>
                    <button id="testAlert" class="btn btn-secondary">Test Alert</button>
                    <button id="testSuccess" class="btn btn-secondary">Test Success</button>
                    <button id="testWarning" class="btn btn-secondary">Test Warning</button>
                </div>
            </section>

            <section class="card">
                <h2>Test Zone Announcements</h2>
                <div class="button-group">
                    <button class="btn btn-secondary" data-test-zone="1">Zone 1</button>
                    <button class="btn btn-secondary" data-test-zone="2">Zone 2</button>
                    <button class="btn btn-secondary" data-test-zone="3">Zone 3</button>
                    <button class="btn btn-secondary" data-test-zone="4">Zone 4</button>
                    <button class="btn btn-secondary" data-test-zone="5">Zone 5</button>
                    <button class="btn btn-secondary" data-test-zone="6">Zone 6</button>
                </div>
            </section>

            <section class="card">
                <h2>Custom Test Message</h2>
                <div class="form-group">
                    <textarea id="customMessage" rows="3" placeholder="Enter custom message to speak..."></textarea>
                </div>
                <button id="speakCustom" class="btn btn-primary">Speak Message</button>
            </section>

            <section class="card">
                <h2>Available Voices</h2>
                <select id="voiceSelect" size="5"></select>
            </section>
        </div>
    </div>

    <script type="module">
        import { audioCoach } from './src/audio-coach.mjs';
        import * as common from '/pages/src/common.mjs';

        // UI State
        let isCoachActive = false;
        const activityLog = [];

        // Initialize tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tab}-tab`).classList.add('active');
            });
        });

        // Load settings into UI
        function loadSettingsUI() {
            const s = audioCoach.settings;
            document.getElementById('enabled').checked = s.enabled;
            document.getElementById('volume').value = s.volume;
            document.getElementById('volume-value').textContent = `${Math.round(s.volume * 100)}%`;
            document.getElementById('ftp').value = s.ftp;
            document.getElementById('powerZoneAlerts').checked = s.powerZoneAlerts;
            document.getElementById('announceZoneChanges').checked = s.announceZoneChanges;
            document.getElementById('targetZone').value = s.targetZone || '';
            document.getElementById('climbAlerts').checked = s.climbAlerts;
            document.getElementById('climbGradientThreshold').value = s.climbGradientThreshold;
            document.getElementById('pacingAlerts').checked = s.pacingAlerts;
            document.getElementById('pacingThreshold').value = s.pacingThreshold;
            document.getElementById('countdownAlerts').checked = s.countdownAlerts;
        }

        // Save settings from UI
        function saveSettingsFromUI() {
            const newSettings = {
                enabled: document.getElementById('enabled').checked,
                volume: parseFloat(document.getElementById('volume').value),
                ftp: parseInt(document.getElementById('ftp').value),
                powerZoneAlerts: document.getElementById('powerZoneAlerts').checked,
                announceZoneChanges: document.getElementById('announceZoneChanges').checked,
                targetZone: parseInt(document.getElementById('targetZone').value) || null,
                climbAlerts: document.getElementById('climbAlerts').checked,
                climbGradientThreshold: parseFloat(document.getElementById('climbGradientThreshold').value),
                pacingAlerts: document.getElementById('pacingAlerts').checked,
                pacingThreshold: parseInt(document.getElementById('pacingThreshold').value),
                countdownAlerts: document.getElementById('countdownAlerts').checked,
            };
            audioCoach.updateSettings(newSettings);
            audioCoach.ftp = newSettings.ftp;
            logActivity('Settings saved');
        }

        // Volume slider
        document.getElementById('volume').addEventListener('input', (e) => {
            const value = Math.round(e.target.value * 100);
            document.getElementById('volume-value').textContent = `${value}%`;
        });

        // Save/Reset buttons
        document.getElementById('saveSettings').addEventListener('click', saveSettingsFromUI);
        document.getElementById('resetSettings').addEventListener('click', () => {
            if (confirm('Reset all settings to defaults?')) {
                audioCoach.updateSettings({
                    enabled: true,
                    volume: 0.8,
                    powerZoneAlerts: true,
                    announceZoneChanges: true,
                    targetZone: null,
                    climbAlerts: true,
                    climbGradientThreshold: 3.0,
                    pacingAlerts: false,
                    pacingThreshold: 10,
                    countdownAlerts: true,
                    ftp: 200,
                });
                loadSettingsUI();
                logActivity('Settings reset to defaults');
            }
        });

        // Toggle coach
        document.getElementById('toggleCoach').addEventListener('click', () => {
            isCoachActive = !isCoachActive;
            const status = document.getElementById('status');
            const btn = document.getElementById('toggleCoach');

            if (isCoachActive) {
                audioCoach.start();
                status.textContent = 'Active';
                status.className = 'status-text active';
                btn.textContent = 'Stop Coaching';
                btn.className = 'btn btn-danger';
                logActivity('Audio coach started');
            } else {
                audioCoach.stop();
                status.textContent = 'Inactive';
                status.className = 'status-text inactive';
                btn.textContent = 'Start Coaching';
                btn.className = 'btn btn-primary';
                logActivity('Audio coach stopped');
            }
        });

        // Test buttons
        document.getElementById('testSpeech').addEventListener('click', () => audioCoach.testAudio());
        document.getElementById('testBeep').addEventListener('click', () => audioCoach.audio.playSound('beep'));
        document.getElementById('testAlert').addEventListener('click', () => audioCoach.audio.playSound('alert'));
        document.getElementById('testSuccess').addEventListener('click', () => audioCoach.audio.playSound('success'));
        document.getElementById('testWarning').addEventListener('click', () => audioCoach.audio.playSound('warning'));

        // Test zone announcements
        document.querySelectorAll('[data-test-zone]').forEach(btn => {
            btn.addEventListener('click', () => {
                const zone = btn.dataset.testZone;
                audioCoach.audio.speak(`Zone ${zone}`);
            });
        });

        // Custom message
        document.getElementById('speakCustom').addEventListener('click', () => {
            const message = document.getElementById('customMessage').value;
            if (message) {
                audioCoach.audio.speak(message, { interrupt: true });
            }
        });

        // Populate voice list
        function populateVoices() {
            const select = document.getElementById('voiceSelect');
            select.innerHTML = '';
            audioCoach.audio.voices.forEach((voice, i) => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = i;
                if (voice === audioCoach.audio.preferredVoice) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        document.getElementById('voiceSelect').addEventListener('change', (e) => {
            audioCoach.audio.preferredVoice = audioCoach.audio.voices[e.target.value];
        });

        // Workout templates
        const workoutTemplates = {
            warmup: [
                { duration: 300, power: 100, name: 'Easy warmup' }
            ],
            'ftp-test': [
                { duration: 300, power: 150, name: 'Warmup' },
                { duration: 1200, power: null, name: 'FTP Test - go as hard as you can' },
                { duration: 300, power: 100, name: 'Cool down' }
            ],
            'vo2max': [
                { duration: 300, power: 150, name: 'Warmup' },
                { duration: 180, power: 350, name: 'VO2 Max interval 1' },
                { duration: 180, power: 100, name: 'Recovery' },
                { duration: 180, power: 350, name: 'VO2 Max interval 2' },
                { duration: 180, power: 100, name: 'Recovery' },
                { duration: 180, power: 350, name: 'VO2 Max interval 3' },
                { duration: 180, power: 100, name: 'Recovery' },
                { duration: 180, power: 350, name: 'VO2 Max interval 4' },
                { duration: 180, power: 100, name: 'Recovery' },
                { duration: 180, power: 350, name: 'VO2 Max interval 5' },
                { duration: 300, power: 100, name: 'Cool down' }
            ],
            threshold: [
                { duration: 300, power: 150, name: 'Warmup' },
                { duration: 600, power: 250, name: 'Threshold interval 1' },
                { duration: 300, power: 100, name: 'Recovery' },
                { duration: 600, power: 250, name: 'Threshold interval 2' },
                { duration: 300, power: 100, name: 'Recovery' },
                { duration: 600, power: 250, name: 'Threshold interval 3' },
                { duration: 300, power: 100, name: 'Cool down' }
            ]
        };

        document.querySelectorAll('[data-workout]').forEach(btn => {
            btn.addEventListener('click', () => {
                const workout = workoutTemplates[btn.dataset.workout];
                audioCoach.setIntervals(workout);
                logActivity(`Loaded ${btn.textContent} workout`);
            });
        });

        // Interval controls
        document.getElementById('startInterval').addEventListener('click', () => {
            audioCoach.startInterval();
            logActivity('Interval workout started');
        });

        document.getElementById('stopInterval').addEventListener('click', () => {
            audioCoach.stopInterval();
            logActivity('Interval workout stopped');
        });

        // Live stats update
        common.subscribe('states', (states) => {
            const athlete = states.watching || states.self;
            if (!athlete) return;

            document.getElementById('live-power').textContent = athlete.power || '--';
            document.getElementById('live-hr').textContent = athlete.heartRate || '--';
            document.getElementById('live-cadence').textContent = athlete.cadence || '--';
            document.getElementById('live-altitude').textContent = athlete.altitude ? Math.round(athlete.altitude) : '--';
            document.getElementById('live-speed').textContent = athlete.speed ? (athlete.speed * 3.6).toFixed(1) : '--';

            if (athlete.power && audioCoach.ftp) {
                const zone = audioCoach.powerZoneMonitor.getPowerZone(athlete.power, audioCoach.ftp);
                document.getElementById('live-zone').textContent = zone;
            } else {
                document.getElementById('live-zone').textContent = '--';
            }
        });

        // Activity log
        function logActivity(message) {
            const timestamp = new Date().toLocaleTimeString();
            activityLog.unshift({ time: timestamp, message });
            if (activityLog.length > 20) activityLog.pop();

            const logEl = document.getElementById('activity-log');
            logEl.innerHTML = activityLog.map(entry =>
                `<div class="log-entry"><span class="log-time">${entry.time}</span> ${entry.message}</div>`
            ).join('');
        }

        // Initialize
        loadSettingsUI();
        setTimeout(populateVoices, 100);
        logActivity('Audio Coach initialized');
    </script>
</body>
</html>
